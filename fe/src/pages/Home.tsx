import { Box, Typography, Stack, Divider } from '@mui/material';
import { useTheme, alpha } from '@mui/material/styles';
import { useNavigate } from 'react-router-dom';
// theme colors come from MUI palette
import ThemedButton from '../components/common/ThemedButton';
import ThemedCard from '../components/common/ThemedCard';
import EmptyState from '../components/common/EmptyState';
import LoadingSpinner from '../components/LoadingSpinner';
import { ArrowForward } from '@mui/icons-material';
import { OPEN_API_DOC_URL } from '../config';
import { PAGINATION } from '../constants/pagination';
import { SPACING } from '../constants/spacing';
import { useDataFetching } from '../hooks/useDataFetching';
import { getHomeNoticeList, getHomeFaqList, getHomeQnaList } from '../api';
import type { UserNoticeItem, UserFaqItem, UserQnaItem } from '@iitp-dabt/common';

export default function Home() {
  const navigate = useNavigate();
  
  const muiTheme = useTheme();
  const palette = muiTheme.palette;
  const openApiDocUrl = OPEN_API_DOC_URL;
  
  // Í≥µÏßÄÏÇ¨Ìï≠ Îç∞Ïù¥ÌÑ∞ ÌéòÏπ≠
  const {
    data: notices,
    isLoading: noticesLoading,
    isEmpty: noticesEmpty,
    isError: noticesError,
    refetch: refetchNotices
  } = useDataFetching({
    fetchFunction: getHomeNoticeList
  });

  // FAQ Îç∞Ïù¥ÌÑ∞ ÌéòÏπ≠
  const {
    data: faqs,
    isLoading: faqsLoading,
    isEmpty: faqsEmpty,
    isError: faqsError,
    refetch: refetchFaqs
  } = useDataFetching({
    fetchFunction: getHomeFaqList
  });

  // Q&A Îç∞Ïù¥ÌÑ∞ ÌéòÏπ≠
  const {
    data: qnas,
    isLoading: qnasLoading,
    isEmpty: qnasEmpty,
    isError: qnasError,
    refetch: refetchQnas
  } = useDataFetching({
    fetchFunction: getHomeQnaList
  });
  
  const handleContentClick = (type: 'notice' | 'faq' | 'qna', id: number) => {
    navigate(`/${type}/${id}`);
  };

  const handleSectionClick = (type: 'notice' | 'faq' | 'qna') => {
    console.log('üè† [Home] Section clicked:', type);
    // ÏÑπÏÖò ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ Îç∞Ïù¥ÌÑ∞Î•º ÏÉàÎ°úÍ≥†Ïπ®
    switch (type) {
      case 'notice':
        refetchNotices();
        break;
      case 'faq':
        refetchFaqs();
        break;
      case 'qna':
        refetchQnas();
        break;
    }
    navigate(`/${type}`);
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  };

  const renderNoticeSection = () => (
    <Box
      id="home-notice-section"
      className="home-notice-section"
      flex={1}
      display="flex"
      flexDirection="column"
      justifyContent="flex-start"
      p={SPACING.LARGE}
      minWidth={0}
      sx={{
        // PÍ∞Ä Ïù¥ÏÉÅÌïòÎ©¥ 4Î°ú ÏàòÏ†ï ÌòÑÏû¨Îäî 3ÏûÑ 
        minWidth: { xs: '100%', md: 0 }, 
        maxWidth: { xs: '100%', md: '100%' },
        background: 'transparent',
        position: 'relative',
        isolation: 'isolate'
      }}
    >
          <ThemedButton
        variant="primary"
        className="home-notice-button"
        onClick={() => handleSectionClick('notice')}
        endIcon={<ArrowForward />}
        sx={{
          width: '100%',
              mb: 2,
              fontSize: { xs: '1.06rem', md: '1.12rem' },
              fontWeight: 700,
              py: { xs: 1.25, md: 1.5 },
              minHeight: { xs: 44, md: 52 },
          position: 'relative',
          isolation: 'isolate',
          '& .MuiButton-endIcon': {
            position: 'absolute !important',
            right: 16,
            top: '50%',
            transform: 'translateY(-50%)',
            isolation: 'isolate'
          }
        }}
      >
        Í≥µÏßÄÏÇ¨Ìï≠
      </ThemedButton>
      
      {/* Ïª®ÌÖêÏ∏† ÏòÅÏó≠ ÌÖåÎëêÎ¶¨ */}
          <Box 
        sx={{ 
          border: `3px solid ${palette.divider}`,
          borderRadius: 3,
          p: 3,
          backgroundColor: 'background.paper',
          flex: 1,
          minHeight: 200,
          boxShadow: 1
        }}
      >
        {noticesLoading ? (
          <LoadingSpinner loading={true} />
        ) : noticesError ? (
          <EmptyState message="Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§." />
        ) : noticesEmpty ? (
          <EmptyState message="Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§." />
        ) : (
          <Stack spacing={1.5}>
            {notices?.notices?.slice(0, PAGINATION.HOME_PAGE_SIZE).map((notice: UserNoticeItem) => (
              <Box
                key={notice.noticeId}
                onClick={() => handleContentClick('notice', notice.noticeId)}
                sx={{
                  p: 2,
                  borderRadius: 2,
                  cursor: 'pointer',
                  transition: 'all 0.2s ease-in-out',
                  border: `1px solid ${palette.divider}`,
                  backgroundColor: 'transparent',
                  '&:hover': {
                    backgroundColor: 'action.hover',
                    borderColor: palette.primary.main,
                    transform: 'translateY(-1px)',
                    boxShadow: 2,
                    '& .content-text': {
                      textDecoration: 'underline',
                      textDecorationColor: palette.text.primary,
                      textDecorationThickness: '2px'
                    }
                  }
                }}
              >
                <Typography 
                  variant="body2" 
                  className="content-text"
                  sx={{ 
                    color: palette.text.secondary,
                    transition: 'all 0.2s ease-in-out',
                    mb: 0.5
                  }}
                >
                  {notice.title}
                </Typography>
                <Typography 
                  variant="caption" 
                  sx={{ 
                    color: palette.text.secondary,
                    opacity: 0.7
                  }}
                >
                  {formatDate(notice.postedAt)}
                </Typography>
              </Box>
            ))}
          </Stack>
        )}
      </Box>
    </Box>
  );

  const renderFaqSection = () => (
    <Box
      id="home-faq-section"
      flex={1}
      display="flex"
      flexDirection="column"
      justifyContent="flex-start"
      p={SPACING.LARGE}
      minWidth={0}
      sx={{
        // PÍ∞Ä Ïù¥ÏÉÅÌïòÎ©¥ 4Î°ú ÏàòÏ†ï ÌòÑÏû¨Îäî 3ÏûÑ 
        minWidth: { xs: '100%', md: 0 }, 
        maxWidth: { xs: '100%', md: '100%' },
        background: 'transparent'
      }}
    >
          <ThemedButton
        variant="primary"
        className="home-faq-button"
        onClick={() => handleSectionClick('faq')}
        endIcon={<ArrowForward />}
        sx={{
          width: '100%',
          mb: SPACING.MEDIUM,
              fontSize: { xs: '1.06rem', md: '1.12rem' },
              fontWeight: 700,
              py: { xs: 1.25, md: 1.5 },
              minHeight: { xs: 44, md: 52 },
          position: 'relative',
          '& .MuiButton-endIcon': {
            position: 'absolute !important',
            right: 16,
            top: '50%',
            transform: 'translateY(-50%)'
          }
        }}
      >
        FAQ
      </ThemedButton>
      
      {/* Ïª®ÌÖêÏ∏† ÏòÅÏó≠ ÌÖåÎëêÎ¶¨ */}
          <Box 
        sx={{ 
          border: `3px solid ${palette.divider}`,
          borderRadius: 3,
          p: SPACING.LARGE,
          backgroundColor: 'background.paper',
          flex: 1,
          minHeight: 200,
          boxShadow: 1
        }}
      >
        {faqsLoading ? (
          <LoadingSpinner loading={true} />
        ) : faqsError ? (
          <EmptyState message="FAQÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§." />
        ) : faqsEmpty ? (
          <EmptyState message="Îì±Î°ùÎêú FAQÍ∞Ä ÏóÜÏäµÎãàÎã§." />
        ) : (
          <Stack spacing={1.5}>
            {faqs?.faqs?.slice(0, PAGINATION.HOME_PAGE_SIZE).map((faq: UserFaqItem) => (
              <Box
                key={faq.faqId}
                onClick={() => handleContentClick('faq', faq.faqId)}
                sx={{
                  p: 2,
                  borderRadius: 2,
                  cursor: 'pointer',
                  transition: 'all 0.2s ease-in-out',
                  border: `1px solid ${palette.divider}`,
                  backgroundColor: 'transparent',
                  '&:hover': {
                    backgroundColor: 'action.hover',
                    borderColor: palette.primary.main,
                    transform: 'translateY(-1px)',
                    boxShadow: 2,
                    '& .content-text': {
                      textDecoration: 'underline',
                      textDecorationColor: palette.text.primary,
                      textDecorationThickness: '2px'
                    }
                  }
                }}
              >
                <Typography 
                  variant="body2" 
                  className="content-text"
                  sx={{ 
                    color: palette.text.secondary,
                    transition: 'all 0.2s ease-in-out'
                  }}
                >
                  Q. {faq.question}
                </Typography>
              </Box>
            ))}
          </Stack>
        )}
      </Box>
    </Box>
  );

  const renderQnaSection = () => (
    <Box
      id="home-qna-section"
      flex={1}
      display="flex"
      flexDirection="column"
      justifyContent="flex-start"
      p={SPACING.LARGE}
      minWidth={0}
      sx={{
        // PÍ∞Ä Ïù¥ÏÉÅÌïòÎ©¥ 4Î°ú ÏàòÏ†ï ÌòÑÏû¨Îäî 3ÏûÑ 
        minWidth: { xs: '100%', md: 0 }, 
        maxWidth: { xs: '100%', md: '100%' },
        background: 'transparent'
      }}
    >
          <ThemedButton
        variant="primary"
        className="home-qna-button"
        onClick={() => handleSectionClick('qna')}
        endIcon={<ArrowForward />}
        sx={{
          width: '100%',
          mb: SPACING.MEDIUM,
              fontSize: { xs: '1.06rem', md: '1.12rem' },
              fontWeight: 700,
              py: { xs: 1.25, md: 1.5 },
              minHeight: { xs: 44, md: 52 },
          position: 'relative',
          '& .MuiButton-endIcon': {
            position: 'absolute !important',
            right: 16,
            top: '50%',
            transform: 'translateY(-50%)'
          }
        }}
      >
        Q&A
      </ThemedButton>
      
      {/* Ïª®ÌÖêÏ∏† ÏòÅÏó≠ ÌÖåÎëêÎ¶¨ */}
          <Box 
        sx={{ 
          border: `3px solid ${palette.divider}`,
          borderRadius: 3,
          p: SPACING.LARGE,
          backgroundColor: 'background.paper',
          flex: 1,
          minHeight: 200,
          boxShadow: 1
        }}
      >
        {qnasLoading ? (
          <LoadingSpinner loading={true} />
        ) : qnasError ? (
          <EmptyState message="Q&AÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§." />
        ) : qnasEmpty ? (
          <EmptyState message="Îì±Î°ùÎêú Q&AÍ∞Ä ÏóÜÏäµÎãàÎã§." />
        ) : (
          <Stack spacing={1.5}>
            {qnas?.qnas?.slice(0, PAGINATION.HOME_PAGE_SIZE).map((qna: UserQnaItem) => (
              <Box
                key={qna.qnaId}
                onClick={() => handleContentClick('qna', qna.qnaId)}
                sx={{
                  p: 2,
                  borderRadius: 2,
                  cursor: 'pointer',
                  transition: 'all 0.2s ease-in-out',
                  border: `1px solid ${palette.divider}`,
                  backgroundColor: 'transparent',
                  '&:hover': {
                    backgroundColor: 'action.hover',
                    borderColor: palette.primary.main,
                    transform: 'translateY(-1px)',
                    boxShadow: 2,
                    '& .content-text': {
                      textDecoration: 'underline',
                      textDecorationColor: palette.text.primary,
                      textDecorationThickness: '2px'
                    }
                  }
                }}
              >
                <Typography 
                  variant="body2" 
                  className="content-text"
                  sx={{ 
                    color: palette.text.secondary,
                    transition: 'all 0.2s ease-in-out',
                    mb: 0.5
                  }}
                >
                  {qna.title}
                </Typography>
                <Typography 
                  variant="caption" 
                  sx={{ 
                    color: palette.text.secondary,
                    opacity: 0.7
                  }}
                >
                  {formatDate(qna.createdAt)}
                </Typography>
              </Box>
            ))}
          </Stack>
        )}
      </Box>
    </Box>
  );
  
  return (
    <Box 
      id="home-page-container"
      className="home-page-container"
      sx={{ 
        minHeight: '100%',
        width: '100%',
        position: 'relative',
        isolation: 'isolate'
      }}
    >
      {/* Ïª®ÌÖêÏ∏† ÎûòÌçº: ÏÜåÍ∞ú+3Íµ¨Ïó≠ */}
      <Box 
        id="home-main-section" 
        className="home-main-section"
        sx={{ 
          width: '100%', 
          maxWidth: '100%', 
          mx: 'auto',
          
          background: palette.background.default,
          py: { xs: 4, md: 8 },
          pb: { xs: 'calc(var(--footer-height, 56px) + 20px)', md: 'calc(var(--footer-height, 56px) + 40px)' },
          position: 'relative',
          isolation: 'isolate'
        }}
      >
        {/* ÏÑúÎπÑÏä§ ÏÜåÍ∞ú */}
      <ThemedCard 
          className="home-intro-section"
          sx={{ 
            width: { xs: '100%', md: '100%' }, 
            mx: 'auto',
            mb: { xs: 4, md: 6 },
            position: 'relative',
            isolation: 'isolate'
          }}
        >
          {/* PÍ∞Ä Ïù¥ÏÉÅÌïòÎ©¥ 4Î°ú ÏàòÏ†ï ÌòÑÏû¨Îäî 3ÏûÑ */}
          <Box sx={{ 
            background: palette.primary.main, 
            borderRadius: 3, 
            p: SPACING.LARGE, 
            boxShadow: 1,
            position: 'relative',
            isolation: 'isolate'
          }}>
            <Typography 
              variant="h4" 
              fontWeight="bold" 
              align="center" 
              gutterBottom 
              sx={{ 
                color: muiTheme.palette.getContrastText(palette.primary.main),
                position: 'relative',
                isolation: 'isolate'
              }}
            >
              Ïû•Ïï†Ïù∏ ÏûêÎ¶Ω ÏÉùÌôú ÏßÄÏõê ÌîåÎû´Ìèº API ÏÑºÌÑ∞
            </Typography>
            <Typography 
              align="center" 
              sx={{ 
                color: muiTheme.palette.getContrastText(palette.primary.main),
                position: 'relative',
                isolation: 'isolate'
              }}
            >
              ÎàÑÍµ¨ÎÇò ÏâΩÍ≥† ÏïàÏ†ÑÌïòÍ≤å Ïû•Ïï†Ïù∏ ÏûêÎ¶Ω ÏÉùÌôú ÏßÄÏõê ÌîåÎû´Ìèº Îç∞Ïù¥ÌÑ∞ APIÎ•º ÌÉêÏÉâÌïòÍ≥† ÌôúÏö©Ìï† Ïàò ÏûàÎäî Í≥µÍ∞ÑÏûÖÎãàÎã§.
            </Typography>
          </Box>
        </ThemedCard>

        {/* Open API Î¨∏ÏÑú Î∞îÎ°úÍ∞ÄÍ∏∞ Î≤ÑÌäº */}
        <Box id="home-openapi-button-row" sx={{ 
          width: { xs: '100%', md: '100%' }, 
          mx: 'auto', 
          mb:  SPACING.MEDIUM,
          display: 'flex',
          justifyContent: 'flex-end',
          position: 'relative',
          isolation: 'isolate'
        }}>
          <ThemedButton
            variant="outlined"
            onClick={() => window.open(openApiDocUrl, '_blank')}
            className="home-api-button"
            sx={{
              fontSize: '1rem',
              px: 3,
              py: 1,
              position: 'relative',
              isolation: 'isolate'
            }}
          >
            Open API Î¨∏ÏÑú Î∞îÎ°úÍ∞ÄÍ∏∞
          </ThemedButton>
        </Box>
        
        {/* 3Íµ¨Ïó≠(Í≥µÏßÄ/FAQ/Q&A) */}
        <ThemedCard 
          className="home-3section"
          sx={{ 
            width: { xs: '100%', md: '100%' }, 
            mx: 'auto',
            position: 'relative',
            isolation: 'isolate'
          }}
        >
          <Stack
            id="home-3section-stack"
            direction={{ xs: 'column', md: 'row' }}
            divider={<Divider orientation="vertical" flexItem sx={{ borderColor: 'transparent' }} />}
            spacing={0}
            sx={{
            background: alpha(palette.secondary.main, 0.06),
              borderRadius: 3,
              boxShadow: 0,
              minHeight: { xs: 600, md: 700 },
              width: '100%',
              justifyContent: 'center',
              alignItems: 'stretch',
              flexWrap: { xs: 'wrap', md: 'nowrap' },
              p: { xs: 2, md: 3 }
            }}
          >
            {renderNoticeSection()}
            {renderFaqSection()}
            {renderQnaSection()}
          </Stack>
        </ThemedCard>
      </Box>
    </Box>
  );
} 